SET SESSION binlog_format='ROW';
CREATE TEMPORARY TABLE tmp (
  a_id INT UNSIGNED NULL DEFAULT NULL,
  name VARCHAR(50) NOT NULL,
  is_happy TINYINT(1) UNSIGNED NOT NULL DEFAULT 1,
  KEY (name)
) ENGINE=InnoDB;
#RESET
#start INSERT INTO tmp (name,is_happy) VALUES
("some data goes here")
#RESET
SET @update_cnt=0;
INSERT INTO a (name,is_happy)
  SELECT name,is_happy
  FROM tmp
  GROUP BY name
  ON DUPLICATE KEY UPDATE a.a_id=IF(@update_cnt:=1,VALUES(a_id),NULL), a.is_happy=IFNULL(VALUE(is_happy),a.is_happy);
DELIMITER |
BEGIN NOT ATOMIC IF @update_cnt THEN
  SET @old_sql_log_bin = @@sql_log_bin;
  SET SESSION sql_log_bin = 0;
    ALTER TABLE a AUTO_INCREMENT = 1;
  SET SESSION sql_log_bin = @old_sql_log_bin;
END IF;END|
DELIMITER ;
UPDATE a JOIN tmp ON tmp.name<=>a.name SET tmp.a_id=a.a_id;
DELETE FROM a WHERE
  a_id NOT IN (SELECT tmp.a_id FROM tmp);
SET @update_cnt=0;
INSERT INTO b (a_id,a_name)
  SELECT a_id,name
  FROM tmp
  WHERE a_id NOT IN (SELECT a_id FROM b)
  GROUP BY a_id
  ON DUPLICATE KEY UPDATE b.a_id=IF(@update_cnt:=1,VALUES(a_id),NULL);
DELIMITER |
BEGIN NOT ATOMIC IF @update_cnt THEN
  SET @old_sql_log_bin = @@sql_log_bin;
  SET SESSION sql_log_bin = 0;
    ALTER TABLE b AUTO_INCREMENT = 1;
  SET SESSION sql_log_bin = @old_sql_log_bin;
END IF;END|
DELIMITER ;
INSERT INTO c (is_happy)
  SELECT is_happy
  FROM tmp
  ON DUPLICATE KEY UPDATE c.is_happy=IFNULL(VALUE(is_happy),c.is_happy);
  SET @old_sql_log_bin = @@sql_log_bin;
  SET SESSION sql_log_bin = 0;
    ALTER TABLE c AUTO_INCREMENT = 1;
  SET SESSION sql_log_bin = @old_sql_log_bin;
