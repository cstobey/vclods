#! /bin/ksh

: ${CONFIG_FILE:=${CONFIG_ENV_PATH:-/etc}/vclods} # Where to find the global config. Fully Qualified version is $CONFIG_FILE
[ -f "$CONFIG_FILE" ] || { echo "CONFIG_FILE must exist - default of /etc/vclods - current $CONFIG_FILE" ; exit 1; }
set -a
: "${VCLOD_BASE_DIR:=$(dirname "$(readlink -f "$(which "$0")")")}"
IS_TERMINAL=$([ -t 1 ] && echo 1 || echo 0)

cat "$CONFIG_FILE" "${VCLOD_BASE_DIR%/}"/includes/* "${VCLOD_BASE_DIR%/}"/connections/* | . /dev/stdin || exit $?

VCLOD_FILE_EXTS="$(ls -1 "${VCLOD_BASE_DIR%/}/extensions/" | paste -sd'|')"
VCLOD_FILE_REGEX='^.*[^.]+(\.('$VCLOD_FILE_EXTS')(-[^.]+)?)+$'
: "${VCLOD_LOCK_DIR:=/dev/shm/}" # Where to put lock files (and internal fifos). Generally /dev/shm
: "${LOG_BASE_DIR:?}" # Where to store log files (will also store error output)
: "${VCLOD_ERR_DIR:?}" # Where to store error files (/dev/shm is a good option)
check_dirs() {
  [ -d "$VCLOD_BASE_DIR" ] || { echo VCLOD_BASE_DIR must be an existing directory; exit; }
  [ -d "$LOG_BASE_DIR" ] && [ -w "$LOG_BASE_DIR" ] || { printf 'LOG_BASE_DIR must be an existing, writable directory\n' ; exit 1; }
  [ -d "$VCLOD_ERR_DIR" ] && [ -w "$VCLOD_ERR_DIR" ] || { printf 'VCLOD_ERR_DIR must be an existing, writable directory\n' ; exit 1; }
  [ -d "$VCLOD_LOCK_DIR" ] && [ -w "$VCLOD_LOCK_DIR" ] || { printf 'VCLOD_LOCK_DIR must be an existing, writable directory\n' ; exit 1; }
}
set +a
check_dirs
